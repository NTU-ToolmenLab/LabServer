# install virtual for better debuging and somewhat
# Optional
sudo apt-get install python3-pip
sudo pip3 install virtualenv
virtualenv env
source env/bin/active

# You can create certs and key by Lets Encrypt it!
# and copy into certs/
# or do optional one
# Optional
openssl genrsa 1024 > privkey.pem
chmod 400 privkey.pem
openssl req -new -x509 -nodes -sha1 -days 365 -key host.key -out fullchain.pem

# traefik
docker pull traefik

# build LoginWeb
cd LoginWeb
vim tzfserver/start.py # modify secrect key and your url(this is bug I think)
touch log
docker build . -t linnil1/tzfserver
touch databse.db
docker run -it --rm -v $(pwd)/database.db:/app/database.db linnil1/tzfserver python3 -c 'from tzfserver import start;start.init_db();'

# build saml
cd saml
vim settings.json
cp ../../traefik/host.cert certs/sp.crt
cp ../../traefik/host.key certs/sp.key
cd ../..

# copy my_vnc
# ...

# Control docker to start or stop
cd DockerServer
docker build . -t linnil1/dockerserver
cd ..

# build example docker-firefox-vnc
cd UserDocker
docker build . -t linnil1/docker-firefox
cd ..

# build nextcloud
docker pull nextcloud:fpm
docker pull nginx
docker pull collabora/code
docker pull mariadb

# modify docker-compose for
# 1. add user (only need to share network see docker-vnc for example),
# 2. change host
# 3. add docker network to extern ...
# 4. nextcloud_db password
vim docker-compose.yml

# Build IDP
cd IDP
# you can see some difference of my version
# https://gist.github.com/linnil1/b782dc567b1f404efcdb71a643ddc7e4
git clone https://github.com/IdentityPython/pysaml2.git
docker build . -t linnil1/idp
cd ..

###
# After running

# Add user
cd LoginWeb
# docker run -it --rm -v $(pwd):/app/LoginWeb -v $(pwd)/database.db:/app/database.db linnil1/tzfserver python3 -c 'from tzfserver import start;start.add();'
docker exec -it labserver_tzfserver_1 python3 -c 'from tzfserver import start;start.add();'
cd ..
# for bash input
# docker run -it --rm -v $(pwd):/app/LoginWeb -v $(pwd)/database.db:/app/database.db linnil1/tzfserver python3
# from tzfserver import start
# start.add_user(name)
# start.add_token(name)

# NextCloud
# Go in to web https://my.domain.ntu.edu.tw:444
# Set admin and password, and choose mysql: hostname=nextclouddb, and the other are same as docker-compose written
# enable collabora (Set https://my.domain.ntu.edu.tw:444)
# enable saml and set like this
"""
"types": "authentication",
"type": "saml",
"general-idp0_display_name": "LoginName",
"general-allow_multiple_user_back_ends": "1",
"general-uid_mapping": "uid",
"saml-attribute-mapping-displayName_mapping": "uid",
"saml-attribute-mapping-quota_mapping": "quota",
"idp-entityId": "myEntityID",
"idp-singleSignOnService.url": "https:\/\/my.domain.ntu.edu.tw:443\/saml\/sso\/redirect",
"idp-singleLogoutService.url": "https:\/\/my.domain.ntu.edu.tw:443\/saml\/slo\/redirect",
"""
# enable external storage

# External Storage
cd Nextcloud
pip3 install requests
vim adduser.py # set user_list
python3 adduser.py
docker exec -it labserver_nextcloud_1 -u 1000 php occ files_external:import my_storges.json
cd ..
